{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Admin Panel - Agricure{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom Admin CSS -->
    <link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}" />
    <link rel="stylesheet" href="{% static 'dashboard/css/admin_sidebar.css' %}" />
    <link rel="stylesheet" href="{% static 'dashboard/css/admin_navbar.css' %}" />

    {% block extra_css %}{% endblock %}
  </head>
  <body class="admin-body">
    <!-- Admin Top Navigation Bar -->
    {% include 'dashboard/admin_navbar.html' %}

    <!-- Main Content -->
    <div class="admin-layout">
      <!-- Admin Sidebar -->
      {% include 'dashboard/admin_sidebar.html' %}

      <!-- Main content area -->
      <main class="admin-main-content">
        <!-- Messages -->
        {% if messages %}
          <div class="admin-messages">
            {% for message in messages %}
            <div
              class="alert alert-{{ message.tags }} alert-dismissible fade show"
              role="alert"
            >
              {{ message }}
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="alert"
              ></button>
            </div>
            {% endfor %}
          </div>
        {% endif %}

        <!-- Page Content -->
        <div class="admin-content">
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom Admin JS -->
    <script src="{% static 'dashboard/js/admin.js' %}"></script>

    {% block extra_js %}{% endblock %}
  </body>
</html>
<!-- Admin Top Navigation Bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark admin-navbar">
  <div class="container-fluid">
    <!-- Brand -->
    <a class="navbar-brand" href="{% url 'dashboard:admin:dashboard' %}">
      <i class="fas fa-seedling"></i>
      <span class="brand-text">Agricure Admin</span>
    </a>

    <!-- Sidebar Toggle -->
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#adminNavbar"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Navbar Content -->
    <div class="collapse navbar-collapse" id="adminNavbar">
      <!-- Left Side - Quick Actions -->
      <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            id="quickActionsDropdown"
            role="button"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-bolt"></i>
            Quick Actions
          </a>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:admin:train_model' %}">
                <i class="fas fa-play"></i>
                Train Model
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:admin:upload_dataset' %}">
                <i class="fas fa-upload"></i>
                Upload Dataset
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:admin:health_check' %}">
                <i class="fas fa-heartbeat"></i>
                Health Check
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:upload' %}">
                <i class="fas fa-camera"></i>
                Test Diagnosis
              </a>
            </li>
          </ul>
        </li>
      </ul>

      <!-- Center - System Status -->
      <ul class="navbar-nav mx-auto">
        <li class="nav-item">
          <span class="navbar-text">
            <i class="fas fa-circle text-success" id="system-status"></i>
            <span id="system-status-text">System Online</span>
          </span>
        </li>
      </ul>

      <!-- Right Side - User Actions -->
      <ul class="navbar-nav">
        <!-- Notifications -->
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            id="notificationsDropdown"
            role="button"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-bell"></i>
            <span class="badge bg-danger" id="notification-count">0</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end notification-dropdown">
            <li><h6 class="dropdown-header">Notifications</h6></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="#">
                <div class="notification-item">
                  <i class="fas fa-info-circle text-info"></i>
                  <div>
                    <strong>No new notifications</strong>
                    <small class="text-muted">All caught up!</small>
                  </div>
                </div>
              </a>
            </li>
          </ul>
        </li>

        <!-- Admin Profile -->
        <li class="nav-item dropdown">
          <a
            class="nav-link dropdown-toggle"
            href="#"
            id="adminProfileDropdown"
            role="button"
            data-bs-toggle="dropdown"
          >
            <i class="fas fa-user-shield"></i>
            <span>{{ user.username }}</span>
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header">Admin Panel</h6></li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:admin:dashboard' %}">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:admin:system_health' %}">
                <i class="fas fa-heartbeat"></i>
                System Health
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li><h6 class="dropdown-header">Account</h6></li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:profile' %}">
                <i class="fas fa-user-edit"></i>
                Profile Settings
              </a>
            </li>
            <li>
              <a class="dropdown-item" href="{% url 'dashboard:home' %}">
                <i class="fas fa-eye"></i>
                View as Farmer
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" href="/admin/logout/">
                <i class="fas fa-sign-out-alt"></i>
                Logout
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Admin Status Bar -->
<div class="admin-status-bar">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-3">
        <div class="status-item">
          <i class="fas fa-brain"></i>
          <span>Models: <strong id="model-count">-</strong></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="status-item">
          <i class="fas fa-chart-line"></i>
          <span>Diagnoses: <strong id="diagnosis-count">-</strong></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="status-item">
          <i class="fas fa-database"></i>
          <span>Dataset: <strong id="dataset-size">-</strong></span>
        </div>
      </div>
      <div class="col-md-3">
        <div class="status-item">
          <i class="fas fa-users"></i>
          <span>Users: <strong id="user-count">-</strong></span>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Admin Sidebar -->
<nav id="admin-sidebar" class="sidebar admin-sidebar">
  <div class="sidebar-sticky">
    <!-- Admin Logo/Brand -->
    <div class="sidebar-brand">
      <i class="fas fa-cogs"></i>
      <span>Admin Panel</span>
    </div>

    <!-- Navigation Sections -->
    <div class="sidebar-nav">
      <!-- Dashboard Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">Dashboard</h3>
        <div class="nav-section-items">
          <a
            class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
            href="{% url 'dashboard:admin:dashboard' %}"
          >
            <i class="fas fa-tachometer-alt"></i>
            <span>Overview</span>
          </a>
          <a
            class="nav-link {% if 'stats' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:api_stats' %}"
          >
            <i class="fas fa-chart-bar"></i>
            <span>Statistics</span>
          </a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Model Management Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">AI Models</h3>
        <div class="nav-section-items">
          <a
            class="nav-link {% if 'model_management' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:model_management' %}"
          >
            <i class="fas fa-brain"></i>
            <span>Model Management</span>
          </a>
          <a
            class="nav-link {% if 'train_model' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:train_model' %}"
          >
            <i class="fas fa-play"></i>
            <span>Train Model</span>
          </a>
          <a
            class="nav-link {% if 'training_logs' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:training_logs' %}"
          >
            <i class="fas fa-list"></i>
            <span>Training Logs</span>
          </a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Dataset Management Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">Dataset</h3>
        <div class="nav-section-items">
          <a
            class="nav-link {% if 'dataset_management' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:dataset_management' %}"
          >
            <i class="fas fa-database"></i>
            <span>Dataset Management</span>
          </a>
          <a
            class="nav-link {% if 'upload_dataset' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:upload_dataset' %}"
          >
            <i class="fas fa-upload"></i>
            <span>Upload Data</span>
          </a>
          <a
            class="nav-link {% if 'validate_dataset' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:validate_dataset' %}"
          >
            <i class="fas fa-check-circle"></i>
            <span>Validate Dataset</span>
          </a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- System Management Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">System</h3>
        <div class="nav-section-items">
          <a
            class="nav-link {% if 'system_health' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:system_health' %}"
          >
            <i class="fas fa-heartbeat"></i>
            <span>System Health</span>
          </a>
          <a
            class="nav-link {% if 'health_check' in request.resolver_match.url_name %}active{% endif %}"
            href="{% url 'dashboard:admin:health_check' %}"
          >
            <i class="fas fa-stethoscope"></i>
            <span>Health Check</span>
          </a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- User Management Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">Users</h3>
        <div class="nav-section-items">
          <a class="nav-link" href="/admin/auth/user/">
            <i class="fas fa-users"></i>
            <span>User Management</span>
          </a>
          <a class="nav-link" href="{% url 'dashboard:history' %}">
            <i class="fas fa-history"></i>
            <span>User Activity</span>
          </a>
        </div>
      </div>

      <div class="divider"></div>

      <!-- Quick Actions Section -->
      <div class="nav-section">
        <h3 class="nav-section-title">Quick Actions</h3>
        <div class="nav-section-items">
          <a
            class="nav-link"
            href="{% url 'dashboard:upload' %}"
          >
            <i class="fas fa-camera"></i>
            <span>Test Diagnosis</span>
          </a>
          <a class="nav-link" href="/admin/">
            <i class="fas fa-cog"></i>
            <span>Django Admin</span>
          </a>
        </div>
      </div>
    </div>

    <!-- Sidebar Footer -->
    <div class="sidebar-footer">
      <div class="footer-item">
        <i class="fas fa-user-shield"></i>
        <span>Admin: {{ user.username }}</span>
      </div>
      <div class="footer-item">
        <a href="{% url 'dashboard:home' %}" class="footer-link">
          <i class="fas fa-eye"></i>
          <span>View as Farmer</span>
        </a>
      </div>
    </div>
  </div>
</nav>
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <!-- Header -->
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-cogs"></i>
            Admin Dashboard
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-brain"></i>
                Models
            </a>
            <a href="{% url 'dashboard:admin:dataset_management' %}" class="admin-nav-link">
                <i class="fas fa-database"></i>
                Dataset
            </a>
            <a href="{% url 'dashboard:admin:training_logs' %}" class="admin-nav-link">
                <i class="fas fa-list"></i>
                Logs
            </a>
            <a href="{% url 'dashboard:admin:system_health' %}" class="admin-nav-link">
                <i class="fas fa-heartbeat"></i>
                System
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-brain"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_models }}</h3>
                <p>Total Models</p>
                <span class="stat-note">{{ active_models }} active</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_diagnoses }}</h3>
                <p>Total Diagnoses</p>
                <span class="stat-note">All time</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-images"></i>
            </div>
            <div class="stat-content">
                <h3>{{ total_images }}</h3>
                <p>Images Processed</p>
                <span class="stat-note">User uploads</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-virus"></i>
            </div>
            <div class="stat-content">
                <h3>{{ disease_stats|length }}</h3>
                <p>Disease Types</p>
                <span class="stat-note">Detected</span>
            </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="admin-content-grid">
        <!-- Model Performance Chart -->
        <div class="admin-card">
            <div class="card-header">
                <h3>Model Performance</h3>
                <div class="card-actions">
                    <a href="{% url 'dashboard:admin:model_management' %}" class="btn btn-sm btn-outline">
                        <i class="fas fa-cog"></i>
                        Manage Models
                    </a>
                </div>
            </div>
            <div class="card-content">
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- Recent Training -->
        <div class="admin-card">
            <div class="card-header">
                <h3>Recent Training</h3>
                <div class="card-actions">
                    <a href="{% url 'dashboard:admin:train_model' %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i>
                        Train New Model
                    </a>
                </div>
            </div>
            <div class="card-content">
                <div class="training-list">
                    {% for training in recent_training %}
                    <div class="training-item">
                        <div class="training-info">
                            <h4>{{ training.version }}</h4>
                            <p>{{ training.training_started_at|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="training-metrics">
                            <span class="metric">
                                <i class="fas fa-chart-line"></i>
                                {{ training.validation_accuracy|floatformat:2 }}%
                            </span>
                            <span class="status status-{{ training.is_active|yesno:'active,inactive' }}">
                                {{ training.is_active|yesno:'Active,Inactive' }}
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-state">No training history available</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Disease Distribution -->
        <div class="admin-card">
            <div class="card-header">
                <h3>Disease Distribution</h3>
                <div class="card-actions">
                    <a href="{% url 'dashboard:admin:dataset_management' %}" class="btn btn-sm btn-outline">
                        <i class="fas fa-database"></i>
                        View Dataset
                    </a>
                </div>
            </div>
            <div class="card-content">
                <div class="disease-chart">
                    <canvas id="diseaseChart" width="300" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Diagnoses -->
        <div class="admin-card">
            <div class="card-header">
                <h3>Recent Diagnoses</h3>
                <div class="card-actions">
                    <a href="{% url 'dashboard:history' %}" class="btn btn-sm btn-outline">
                        <i class="fas fa-history"></i>
                        View All
                    </a>
                </div>
            </div>
            <div class="card-content">
                <div class="diagnosis-list">
                    {% for diagnosis in recent_diagnoses %}
                    <div class="diagnosis-item">
                        <div class="diagnosis-info">
                            <h4>{{ diagnosis.detected_disease.name|default:"Healthy" }}</h4>
                            <p>{{ diagnosis.crop_image.user.username }} • {{ diagnosis.created_at|timesince }} ago</p>
                        </div>
                        <div class="diagnosis-metrics">
                            <span class="confidence">{{ diagnosis.confidence_score|floatformat:1 }}%</span>
                            <span class="severity severity-{{ diagnosis.severity }}">{{ diagnosis.severity|title }}</span>
                        </div>
                    </div>
                    {% empty %}
                    <p class="empty-state">No recent diagnoses</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Default data if not provided by Django
    const accuracyData = {{ accuracy_data|safe|default:"[]" }};
    const diseaseStats = {{ disease_stats|safe|default:"[]" }};

    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: accuracyData.map(d => d.date) || ['No Data'],
            datasets: [{
                label: 'Training Accuracy',
                data: accuracyData.map(d => d.training_accuracy * 100) || [0],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4
            }, {
                label: 'Validation Accuracy',
                data: accuracyData.map(d => d.validation_accuracy * 100) || [0],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });

    // Disease Distribution Chart
    const diseaseCtx = document.getElementById('diseaseChart').getContext('2d');
    const diseaseChart = new Chart(diseaseCtx, {
        type: 'doughnut',
        data: {
            labels: diseaseStats.map(d => d.name) || ['No Data'],
            datasets: [{
                data: diseaseStats.map(d => d.diagnosis_count) || [1],
                backgroundColor: [
                    '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
});
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block title %}Dataset Management - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-database"></i>
            Dataset Management
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:dashboard' %}" class="admin-nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-brain"></i>
                Models
            </a>
            <a href="{% url 'dashboard:admin:train_model' %}" class="admin-nav-link">
                <i class="fas fa-play"></i>
                Train Model
            </a>
        </div>
    </div>

    <!-- Dataset Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-images"></i>
            </div>
            <div class="stat-content">
                <h3>{{ dataset_stats.total_images }}</h3>
                <p>Total Images</p>
                <div class="stat-note">Across all disease classes</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-virus"></i>
            </div>
            <div class="stat-content">
                <h3>{{ dataset_stats.total_classes }}</h3>
                <p>Disease Classes</p>
                <div class="stat-note">Different disease types</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-hdd"></i>
            </div>
            <div class="stat-content">
                <h3>{{ dataset_stats.total_size_mb|floatformat:1 }} MB</h3>
                <p>Dataset Size</p>
                <div class="stat-note">Total storage used</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <h3>{{ dataset_stats.corrupted_files }}</h3>
                <p>Corrupted Files</p>
                <div class="stat-note">Files that need attention</div>
            </div>
        </div>
    </div>

    <!-- Dataset Actions -->
    <div class="admin-content-grid">
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-tools"></i>
                    Dataset Actions
                </h3>
            </div>
            <div class="card-content">
                <div class="action-grid">
                    <div class="action-item">
                        <div class="action-icon">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="action-content">
                            <h4>Upload Dataset</h4>
                            <p>Upload new images to expand your dataset</p>
                            <button class="btn btn-primary" onclick="showUploadModal()">
                                <i class="fas fa-upload"></i>
                                Upload Images
                            </button>
                        </div>
                    </div>

                    <div class="action-item">
                        <div class="action-icon">
                            <i class="fas fa-broom"></i>
                        </div>
                        <div class="action-content">
                            <h4>Clean Dataset</h4>
                            <p>Remove corrupted or invalid images</p>
                            <form method="post" action="{% url 'dashboard:admin:clean_dataset' %}" class="inline-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-secondary" onclick="return confirm('This will remove all corrupted files. Continue?')">
                                    <i class="fas fa-broom"></i>
                                    Clean Dataset
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="action-item">
                        <div class="action-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="action-content">
                            <h4>Validate Dataset</h4>
                            <p>Check dataset integrity and balance</p>
                            <form method="post" action="{% url 'dashboard:admin:validate_dataset' %}" class="inline-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check-circle"></i>
                                    Validate
                                </button>
                            </form>
                        </div>
                    </div>

                    <div class="action-item">
                        <div class="action-icon">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="action-content">
                            <h4>Export Dataset</h4>
                            <p>Download dataset information as CSV</p>
                            <button class="btn btn-outline" onclick="exportDataset()">
                                <i class="fas fa-download"></i>
                                Export CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-chart-pie"></i>
                    Class Distribution
                </h3>
            </div>
            <div class="card-content">
                <canvas id="classDistributionChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Disease Classes -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-list"></i>
                Disease Classes
            </h3>
            <div class="card-actions">
                <button class="btn btn-outline btn-sm" onclick="toggleClassView()">
                    <i class="fas fa-th"></i>
                    Toggle View
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="class-grid" id="classGrid">
                {% for class_info in disease_classes %}
                <div class="class-card">
                    <div class="class-header">
                        <h4>{{ class_info.name }}</h4>
                        <span class="class-count">{{ class_info.count }} images</span>
                    </div>
                    
                    <div class="class-stats">
                        <div class="stat-item">
                            <div class="stat-label">Percentage</div>
                            <div class="stat-value">{{ class_info.percentage|floatformat:1 }}%</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Size</div>
                            <div class="stat-value">{{ class_info.size_mb|floatformat:1 }} MB</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">Health</div>
                            <div class="stat-value">
                                {% if class_info.health_score > 80 %}
                                    <span class="health-good">Good</span>
                                {% elif class_info.health_score > 60 %}
                                    <span class="health-fair">Fair</span>
                                {% else %}
                                    <span class="health-poor">Poor</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="class-samples">
                        <h5>Sample Images</h5>
                        <div class="sample-images">
                            {% for sample in class_info.samples %}
                            <img src="{{ sample.image.url }}" alt="Sample" class="sample-image">
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="class-actions">
                        <button class="btn btn-sm btn-outline" onclick="viewClassDetails('{{ class_info.name }}')">
                            <i class="fas fa-eye"></i>
                            View Details
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="downloadClass('{{ class_info.name }}')">
                            <i class="fas fa-download"></i>
                            Download
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Dataset Health Report -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-heartbeat"></i>
                Dataset Health Report
            </h3>
            <div class="card-actions">
                <button class="btn btn-outline btn-sm" onclick="generateHealthReport()">
                    <i class="fas fa-sync"></i>
                    Refresh Report
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="health-report">
                <div class="health-item">
                    <div class="health-icon">
                        {% if dataset_health.balance_score > 80 %}
                            <i class="fas fa-check-circle text-success"></i>
                        {% elif dataset_health.balance_score > 60 %}
                            <i class="fas fa-exclamation-circle text-warning"></i>
                        {% else %}
                            <i class="fas fa-times-circle text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="health-content">
                        <h4>Class Balance</h4>
                        <p>{{ dataset_health.balance_score }}% - {{ dataset_health.balance_status }}</p>
                        <div class="health-suggestion">
                            {{ dataset_health.balance_suggestion }}
                        </div>
                    </div>
                </div>

                <div class="health-item">
                    <div class="health-icon">
                        {% if dataset_health.quality_score > 80 %}
                            <i class="fas fa-check-circle text-success"></i>
                        {% elif dataset_health.quality_score > 60 %}
                            <i class="fas fa-exclamation-circle text-warning"></i>
                        {% else %}
                            <i class="fas fa-times-circle text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="health-content">
                        <h4>Image Quality</h4>
                        <p>{{ dataset_health.quality_score }}% - {{ dataset_health.quality_status }}</p>
                        <div class="health-suggestion">
                            {{ dataset_health.quality_suggestion }}
                        </div>
                    </div>
                </div>

                <div class="health-item">
                    <div class="health-icon">
                        {% if dataset_health.diversity_score > 80 %}
                            <i class="fas fa-check-circle text-success"></i>
                        {% elif dataset_health.diversity_score > 60 %}
                            <i class="fas fa-exclamation-circle text-warning"></i>
                        {% else %}
                            <i class="fas fa-times-circle text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="health-content">
                        <h4>Dataset Diversity</h4>
                        <p>{{ dataset_health.diversity_score }}% - {{ dataset_health.diversity_status }}</p>
                        <div class="health-suggestion">
                            {{ dataset_health.diversity_suggestion }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Upload Dataset Images</h3>
            <button class="close-modal" onclick="closeUploadModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadForm" method="post" action="{% url 'dashboard:admin:upload_dataset' %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="disease_class">Disease Class</label>
                    <select name="disease_class" id="disease_class" class="form-control" required>
                        <option value="">Select Disease Class</option>
                        {% for class_info in disease_classes %}
                        <option value="{{ class_info.name }}">{{ class_info.name }}</option>
                        {% endfor %}
                        <option value="new">Create New Class</option>
                    </select>
                </div>
                
                <div class="form-group" id="newClassGroup" style="display: none;">
                    <label for="new_class_name">New Class Name</label>
                    <input type="text" name="new_class_name" id="new_class_name" class="form-control" placeholder="Enter new disease class name">
                </div>
                
                <div class="form-group">
                    <label for="images">Images</label>
                    <input type="file" name="images" id="images" class="form-control" multiple accept="image/*" required>
                    <div class="form-help">Select multiple images to upload</div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i>
                        Upload Images
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeUploadModal()">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.action-item {
    padding: 20px;
    background: #f9fafb;
    border-radius: 8px;
    display: flex;
    gap: 16px;
    align-items: flex-start;
}

.action-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
    flex-shrink: 0;
}

.action-content h4 {
    margin: 0 0 8px 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.action-content p {
    margin: 0 0 16px 0;
    color: #6b7280;
    font-size: 0.875rem;
}

.class-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.class-card {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e5e7eb;
}

.class-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.class-header h4 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.class-count {
    font-size: 0.875rem;
    color: #6b7280;
    background: white;
    padding: 4px 8px;
    border-radius: 4px;
}

.class-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

.stat-item {
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 4px;
}

.stat-value {
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
}

.health-good {
    color: #10b981;
}

.health-fair {
    color: #f59e0b;
}

.health-poor {
    color: #ef4444;
}

.class-samples h5 {
    margin: 0 0 8px 0;
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
}

.sample-images {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 8px;
}

.sample-image {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #e5e7eb;
    flex-shrink: 0;
}

.class-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
}

.health-report {
    space-y: 20px;
}

.health-item {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    padding: 20px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 16px;
}

.health-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.health-content h4 {
    margin: 0 0 8px 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.health-content p {
    margin: 0 0 8px 0;
    color: #374151;
}

.health-suggestion {
    font-size: 0.875rem;
    color: #6b7280;
    font-style: italic;
}

.text-success {
    color: #10b981;
}

.text-warning {
    color: #f59e0b;
}

.text-danger {
    color: #ef4444;
}

.table-responsive {
    overflow-x: auto;
}

.btn-group {
    display: flex;
    gap: 8px;
}

#newClassGroup {
    display: none;
}

.modal {
    display: none;
}

.modal.show {
    display: block;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Class Distribution Chart
    const ctx = document.getElementById('classDistributionChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ class_labels|safe }},
            datasets: [{
                data: {{ class_counts|safe }},
                backgroundColor: [
                    '#10b981',
                    '#3b82f6',
                    '#ef4444',
                    '#f59e0b',
                    '#8b5cf6',
                    '#ec4899',
                    '#14b8a6',
                    '#f97316'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
});

function showUploadModal() {
    document.getElementById('uploadModal').classList.add('show');
}

function closeUploadModal() {
    document.getElementById('uploadModal').classList.remove('show');
}

document.getElementById('disease_class').addEventListener('change', function() {
    const newClassGroup = document.getElementById('newClassGroup');
    if (this.value === 'new') {
        newClassGroup.style.display = 'block';
        document.getElementById('new_class_name').required = true;
    } else {
        newClassGroup.style.display = 'none';
        document.getElementById('new_class_name').required = false;
    }
});

function toggleClassView() {
    const classGrid = document.getElementById('classGrid');
    classGrid.classList.toggle('list-view');
}

function viewClassDetails(className) {
    // Implement class details view
    alert('View details for: ' + className);
}

function downloadClass(className) {
    // Implement class download
    alert('Download class: ' + className);
}

function exportDataset() {
    // Create CSV data
    const csvData = [
        ['Disease Class', 'Image Count', 'Percentage', 'Size (MB)', 'Health Score']
    ];
    
    {% for class_info in disease_classes %}
    csvData.push([
        '{{ class_info.name }}',
        '{{ class_info.count }}',
        '{{ class_info.percentage|floatformat:1 }}',
        '{{ class_info.size_mb|floatformat:1 }}',
        '{{ class_info.health_score }}'
    ]);
    {% endfor %}
    
    // Convert to CSV string
    const csvString = csvData.map(row => row.join(',')).join('\n');
    
    // Download CSV
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'dataset_info_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function generateHealthReport() {
    fetch('{% url "dashboard:admin:validate_dataset" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error generating health report: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating health report');
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('uploadModal');
    if (event.target === modal) {
        closeUploadModal();
    }
}
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-model-management">
    <!-- Header -->
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-brain"></i>
            Model Management
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-dashboard"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:admin:train_model' %}" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Train New Model
            </a>
        </div>
    </div>

    <!-- Active Model Card -->
    {% if active_model %}
    <div class="active-model-card">
        <div class="model-header">
            <h3>
                <i class="fas fa-star"></i>
                Active Model
            </h3>
            <span class="model-status active">ACTIVE</span>
        </div>
        <div class="model-info">
            <div class="model-details">
                <h4>{{ active_model.version }}</h4>
                <p>Training completed: {{ active_model.training_completed_at|date:"M d, Y H:i" }}</p>
                <div class="model-metrics">
                    <div class="metric">
                        <span class="metric-label">Training Accuracy</span>
                        <span class="metric-value">{{ active_model.training_accuracy|floatformat:2 }}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Validation Accuracy</span>
                        <span class="metric-value">{{ active_model.validation_accuracy|floatformat:2 }}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Dataset Size</span>
                        <span class="metric-value">{{ active_model.dataset_size }}</span>
                    </div>
                </div>
            </div>
            <div class="model-actions">
                <a href="{% url 'dashboard:admin:model_performance' model.id %}" class="btn btn-outline">
                    <i class="fas fa-chart-line"></i>
                    View Performance
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Models List -->
    <div class="models-section">
        <div class="section-header">
            <h3>All Models</h3>
            <div class="models-filter">
                <select id="modelFilter" class="form-select">
                    <option value="all">All Models</option>
                    <option value="active">Active Only</option>
                    <option value="inactive">Inactive Only</option>
                </select>
            </div>
        </div>

        <div class="models-list">
            {% for model in models %}
            <div class="model-card {% if model.is_active %}model-active{% endif %}">
                <div class="model-header">
                    <h4>{{ model.version }}</h4>
                    <div class="model-badges">
                        {% if model.is_active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-secondary">Inactive</span>
                        {% endif %}
                        <span class="badge badge-info">{{ model.model_architecture }}</span>
                    </div>
                </div>

                <div class="model-content">
                    <div class="model-metrics">
                        <div class="metric-grid">
                            <div class="metric-item">
                                <span class="metric-label">Training Accuracy</span>
                                <span class="metric-value">{{ model.training_accuracy|floatformat:2 }}%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Validation Accuracy</span>
                                <span class="metric-value">{{ model.validation_accuracy|floatformat:2 }}%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Dataset Size</span>
                                <span class="metric-value">{{ model.dataset_size }}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Epochs</span>
                                <span class="metric-value">{{ model.epochs }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="model-info">
                        <p><strong>Started:</strong> {{ model.training_started_at|date:"M d, Y H:i" }}</p>
                        {% if model.training_completed_at %}
                        <p><strong>Completed:</strong> {{ model.training_completed_at|date:"M d, Y H:i" }}</p>
                        <p><strong>Duration:</strong> {{ model.training_duration }}</p>
                        {% else %}
                        <p class="training-status">
                            <i class="fas fa-spinner fa-spin"></i>
                            Training in progress...
                        </p>
                        {% endif %}
                    </div>

                    <div class="model-actions">
                        <a href="{% url 'admin_model_performance' model.id %}" class="btn btn-sm btn-outline">
                            <i class="fas fa-chart-line"></i>
                            Performance
                        </a>
                        
                        {% if not model.is_active %}
                        <form method="post" action="{% url 'admin_activate_model' model.id %}" class="inline-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-success" 
                                    onclick="return confirm('Are you sure you want to activate this model?')">
                                <i class="fas fa-play"></i>
                                Activate
                            </button>
                        </form>
                        {% endif %}

                        {% if not model.is_active %}
                        <form method="post" action="{% url 'admin_delete_model' model.id %}" class="inline-form">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-danger" 
                                    onclick="return confirm('Are you sure you want to delete this model? This action cannot be undone.')">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-brain fa-3x"></i>
                <h3>No Models Available</h3>
                <p>Train your first model to get started with AI-powered crop diagnosis.</p>
                <a href="{% url 'admin_train_model' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Train New Model
                </a>
            </div>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if models.has_other_pages %}
        <div class="pagination-container">
            <div class="pagination">
                {% if models.has_previous %}
                <a href="?page={{ models.previous_page_number }}" class="page-link">
                    <i class="fas fa-chevron-left"></i>
                    Previous
                </a>
                {% endif %}

                {% for num in models.paginator.page_range %}
                {% if models.number == num %}
                <span class="page-link active">{{ num }}</span>
                {% else %}
                <a href="?page={{ num }}" class="page-link">{{ num }}</a>
                {% endif %}
                {% endfor %}

                {% if models.has_next %}
                <a href="?page={{ models.next_page_number }}" class="page-link">
                    Next
                    <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Training Status Modal -->
    <div id="trainingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Training Status</h3>
                <button type="button" class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="trainingStatus"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Model filtering
document.getElementById('modelFilter').addEventListener('change', function() {
    const filter = this.value;
    const models = document.querySelectorAll('.model-card');
    
    models.forEach(model => {
        if (filter === 'all') {
            model.style.display = 'block';
        } else if (filter === 'active') {
            model.style.display = model.classList.contains('model-active') ? 'block' : 'none';
        } else if (filter === 'inactive') {
            model.style.display = !model.classList.contains('model-active') ? 'block' : 'none';
        }
    });
});

// Check training status periodically
function checkTrainingStatus() {
    fetch('{% url "admin_get_training_status" %}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'training') {
                // Show training indicator
                document.querySelectorAll('.training-status').forEach(el => {
                    el.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Training in progress...';
                });
                
                // Check again in 30 seconds
                setTimeout(checkTrainingStatus, 30000);
            } else if (data.status === 'completed') {
                // Refresh page to show updated model
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error checking training status:', error);
        });
}

// Start checking training status
checkTrainingStatus();

// Modal handling
const modal = document.getElementById('trainingModal');
const closeModal = document.querySelector('.close-modal');

closeModal.addEventListener('click', function() {
    modal.style.display = 'none';
});

window.addEventListener('click', function(event) {
    if (event.target === modal) {
        modal.style.display = 'none';
    }
});
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block title %}Model Performance - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-chart-line"></i>
            Model Performance
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:dashboard' %}" class="admin-nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-brain"></i>
                Models
            </a>
            <a href="{% url 'dashboard:admin:train_model' %}" class="admin-nav-link">
                <i class="fas fa-play"></i>
                Train Model
            </a>
        </div>
    </div>

    <!-- Active Model Performance -->
    {% if active_model %}
    <div class="active-model-card">
        <div class="model-header">
            <h3>
                <i class="fas fa-star"></i>
                Active Model: {{ active_model.name }}
            </h3>
            <span class="model-status active">
                <i class="fas fa-check-circle"></i>
                Active
            </span>
        </div>
        
        <div class="model-info">
            <div class="model-details">
                <h4>{{ active_model.name }}</h4>
                <p>{{ active_model.description }}</p>
                <div class="model-metadata">
                    <span class="metric">
                        <i class="fas fa-calendar"></i>
                        Created: {{ active_model.created_at|date:"M d, Y" }}
                    </span>
                    <span class="metric">
                        <i class="fas fa-download"></i>
                        Size: {{ active_model.size_mb|floatformat:1 }} MB
                    </span>
                </div>
            </div>
            
            <div class="model-metrics">
                <div class="metric">
                    <div class="metric-label">Accuracy</div>
                    <div class="metric-value">{{ active_model.accuracy|floatformat:2 }}%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Precision</div>
                    <div class="metric-value">{{ active_model.precision|floatformat:2 }}%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Recall</div>
                    <div class="metric-value">{{ active_model.recall|floatformat:2 }}%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">F1 Score</div>
                    <div class="metric-value">{{ active_model.f1_score|floatformat:2 }}%</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Performance Charts -->
    <div class="admin-content-grid">
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-chart-area"></i>
                    Training History
                </h3>
                <div class="card-actions">
                    <select id="modelSelect" class="form-control" style="width: 200px;">
                        <option value="">All Models</option>
                        {% for model in models %}
                        <option value="{{ model.id }}" {% if model.id == active_model.id %}selected{% endif %}>
                            {{ model.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="card-content">
                <canvas id="trainingChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-chart-pie"></i>
                    Performance Metrics
                </h3>
            </div>
            <div class="card-content">
                <canvas id="metricsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Detailed Performance Table -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-table"></i>
                Model Comparison
            </h3>
            <div class="card-actions">
                <button class="btn btn-outline btn-sm" onclick="exportPerformanceData()">
                    <i class="fas fa-download"></i>
                    Export Data
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Model</th>
                            <th>Version</th>
                            <th>Accuracy</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>F1 Score</th>
                            <th>Training Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in models %}
                        <tr {% if model.is_active %}class="table-active"{% endif %}>
                            <td>
                                <strong>{{ model.name }}</strong>
                                {% if model.is_active %}
                                    <span class="badge badge-success">Active</span>
                                {% endif %}
                            </td>
                            <td>{{ model.version }}</td>
                            <td>{{ model.accuracy|floatformat:2 }}%</td>
                            <td>{{ model.precision|floatformat:2 }}%</td>
                            <td>{{ model.recall|floatformat:2 }}%</td>
                            <td>{{ model.f1_score|floatformat:2 }}%</td>
                            <td>{{ model.training_time|floatformat:1 }}h</td>
                            <td>
                                {% if model.is_active %}
                                    <span class="status status-active">Active</span>
                                {% else %}
                                    <span class="status status-inactive">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'dashboard:admin:model_performance_detail' model.id %}" class="btn btn-sm btn-outline">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </a>
                                    {% if not model.is_active %}
                                    <form method="post" action="{% url 'dashboard:admin:activate_model' model.id %}" class="inline-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-success">
                                            <i class="fas fa-play"></i>
                                            Activate
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-brain fa-3x"></i>
                                    <h3>No Models Found</h3>
                                    <p>Train your first model to see performance metrics</p>
                                    <a href="{% url 'dashboard:admin:train_model' %}" class="btn btn-primary">
                                        <i class="fas fa-play"></i>
                                        Start Training
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Class-wise Performance -->
    {% if class_performance %}
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-chart-bar"></i>
                Class-wise Performance
            </h3>
        </div>
        <div class="card-content">
            <canvas id="classPerformanceChart" width="400" height="200"></canvas>
            
            <div class="class-performance-table">
                <table class="table mt-4">
                    <thead>
                        <tr>
                            <th>Disease Class</th>
                            <th>Precision</th>
                            <th>Recall</th>
                            <th>F1 Score</th>
                            <th>Support</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for class_name, metrics in class_performance.items %}
                        <tr>
                            <td><strong>{{ class_name }}</strong></td>
                            <td>{{ metrics.precision|floatformat:2 }}%</td>
                            <td>{{ metrics.recall|floatformat:2 }}%</td>
                            <td>{{ metrics.f1_score|floatformat:2 }}%</td>
                            <td>{{ metrics.support }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Training History Chart
    const trainingCtx = document.getElementById('trainingChart').getContext('2d');
    const trainingChart = new Chart(trainingCtx, {
        type: 'line',
        data: {
            labels: {{ training_history.epochs|safe }},
            datasets: [{
                label: 'Training Accuracy',
                data: {{ training_history.train_accuracy|safe }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true
            }, {
                label: 'Validation Accuracy',
                data: {{ training_history.val_accuracy|safe }},
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Training Progress'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Performance Metrics Chart
    const metricsCtx = document.getElementById('metricsChart').getContext('2d');
    const metricsChart = new Chart(metricsCtx, {
        type: 'radar',
        data: {
            labels: ['Accuracy', 'Precision', 'Recall', 'F1 Score'],
            datasets: [{
                label: 'Current Model',
                data: [
                    {{ active_model.accuracy|default:0 }},
                    {{ active_model.precision|default:0 }},
                    {{ active_model.recall|default:0 }},
                    {{ active_model.f1_score|default:0 }}
                ],
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                borderColor: '#10b981',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Class Performance Chart
    {% if class_performance %}
    const classCtx = document.getElementById('classPerformanceChart').getContext('2d');
    const classChart = new Chart(classCtx, {
        type: 'bar',
        data: {
            labels: {{ class_performance.labels|safe }},
            datasets: [{
                label: 'Precision',
                data: {{ class_performance.precision|safe }},
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: '#10b981',
                borderWidth: 1
            }, {
                label: 'Recall',
                data: {{ class_performance.recall|safe }},
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: '#ef4444',
                borderWidth: 1
            }, {
                label: 'F1 Score',
                data: {{ class_performance.f1_score|safe }},
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: '#3b82f6',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    {% endif %}

    // Model selection change handler
    document.getElementById('modelSelect').addEventListener('change', function() {
        const modelId = this.value;
        if (modelId) {
            window.location.href = '{% url "dashboard:admin:model_performance_detail" 0 %}'.replace('0', modelId);
        } else {
            window.location.href = '{% url "dashboard:admin:model_performance" %}';
        }
    });
});

function exportPerformanceData() {
    // Create CSV data
    const csvData = [
        ['Model', 'Version', 'Accuracy', 'Precision', 'Recall', 'F1 Score', 'Training Time', 'Status']
    ];
    
    {% for model in models %}
    csvData.push([
        '{{ model.name }}',
        '{{ model.version }}',
        '{{ model.accuracy|floatformat:2 }}',
        '{{ model.precision|floatformat:2 }}',
        '{{ model.recall|floatformat:2 }}',
        '{{ model.f1_score|floatformat:2 }}',
        '{{ model.training_time|floatformat:1 }}',
        '{% if model.is_active %}Active{% else %}Inactive{% endif %}'
    ]);
    {% endfor %}
    
    // Convert to CSV string
    const csvString = csvData.map(row => row.join(',')).join('\n');
    
    // Download CSV
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'model_performance_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block title %}System Health - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-heartbeat"></i>
            System Health
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:dashboard' %}" class="admin-nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-brain"></i>
                Models
            </a>
            <a href="{% url 'dashboard:admin:train_model' %}" class="admin-nav-link">
                <i class="fas fa-play"></i>
                Train Model
            </a>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="stats-grid">
        <div class="stat-card {% if system_health.overall_status == 'healthy' %}stat-healthy{% elif system_health.overall_status == 'warning' %}stat-warning{% else %}stat-error{% endif %}">
            <div class="stat-icon">
                {% if system_health.overall_status == 'healthy' %}
                    <i class="fas fa-check-circle"></i>
                {% elif system_health.overall_status == 'warning' %}
                    <i class="fas fa-exclamation-triangle"></i>
                {% else %}
                    <i class="fas fa-times-circle"></i>
                {% endif %}
            </div>
            <div class="stat-content">
                <h3>{{ system_health.overall_status|title }}</h3>
                <p>System Status</p>
                <div class="stat-note">{{ system_health.overall_score }}% Health Score</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="stat-content">
                <h3>{{ system_health.cpu_usage }}%</h3>
                <p>CPU Usage</p>
                <div class="stat-note">{{ system_health.cpu_cores }} cores available</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-memory"></i>
            </div>
            <div class="stat-content">
                <h3>{{ system_health.memory_usage }}%</h3>
                <p>Memory Usage</p>
                <div class="stat-note">{{ system_health.memory_total_gb|floatformat:1 }} GB total</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-hdd"></i>
            </div>
            <div class="stat-content">
                <h3>{{ system_health.disk_usage }}%</h3>
                <p>Disk Usage</p>
                <div class="stat-note">{{ system_health.disk_free_gb|floatformat:1 }} GB free</div>
            </div>
        </div>
    </div>

    <!-- Health Checks -->
    <div class="admin-content-grid">
        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-stethoscope"></i>
                    Health Checks
                </h3>
                <div class="card-actions">
                    <button class="btn btn-outline btn-sm" onclick="runHealthCheck()">
                        <i class="fas fa-sync"></i>
                        Run Check
                    </button>
                </div>
            </div>
            <div class="card-content">
                <div class="health-checks">
                    {% for check in health_checks %}
                    <div class="health-check-item">
                        <div class="check-icon">
                            {% if check.status == 'pass' %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% elif check.status == 'warning' %}
                                <i class="fas fa-exclamation-triangle text-warning"></i>
                            {% else %}
                                <i class="fas fa-times-circle text-danger"></i>
                            {% endif %}
                        </div>
                        <div class="check-content">
                            <h4>{{ check.name }}</h4>
                            <p>{{ check.description }}</p>
                            {% if check.status != 'pass' %}
                                <div class="check-details">
                                    <strong>Issue:</strong> {{ check.message }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="check-status">
                            <span class="status status-{{ check.status }}">{{ check.status|title }}</span>
                            <div class="check-time">{{ check.last_check|timesince }} ago</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="admin-card">
            <div class="card-header">
                <h3>
                    <i class="fas fa-chart-area"></i>
                    Resource Usage
                </h3>
            </div>
            <div class="card-content">
                <canvas id="resourceChart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- AI Service Status -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-robot"></i>
                AI Service Status
            </h3>
        </div>
        <div class="card-content">
            <div class="service-grid">
                <div class="service-item">
                    <div class="service-icon">
                        {% if ai_service.status == 'running' %}
                            <i class="fas fa-play-circle text-success"></i>
                        {% else %}
                            <i class="fas fa-stop-circle text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="service-content">
                        <h4>AI Service</h4>
                        <p>{{ ai_service.status|title }}</p>
                        <div class="service-details">
                            <span>Model: {{ ai_service.active_model }}</span>
                            <span>Version: {{ ai_service.model_version }}</span>
                            <span>Last Prediction: {{ ai_service.last_prediction|timesince }} ago</span>
                        </div>
                    </div>
                    <div class="service-actions">
                        {% if ai_service.status == 'running' %}
                            <button class="btn btn-sm btn-danger" onclick="stopAiService()">
                                <i class="fas fa-stop"></i>
                                Stop
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-success" onclick="startAiService()">
                                <i class="fas fa-play"></i>
                                Start
                            </button>
                        {% endif %}
                        <button class="btn btn-sm btn-outline" onclick="restartAiService()">
                            <i class="fas fa-sync"></i>
                            Restart
                        </button>
                    </div>
                </div>

                <div class="service-item">
                    <div class="service-icon">
                        {% if database.status == 'healthy' %}
                            <i class="fas fa-database text-success"></i>
                        {% else %}
                            <i class="fas fa-database text-danger"></i>
                        {% endif %}
                    </div>
                    <div class="service-content">
                        <h4>Database</h4>
                        <p>{{ database.status|title }}</p>
                        <div class="service-details">
                            <span>Size: {{ database.size_mb|floatformat:1 }} MB</span>
                            <span>Tables: {{ database.table_count }}</span>
                            <span>Last Backup: {{ database.last_backup|timesince }} ago</span>
                        </div>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-outline" onclick="backupDatabase()">
                            <i class="fas fa-download"></i>
                            Backup
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="optimizeDatabase()">
                            <i class="fas fa-tools"></i>
                            Optimize
                        </button>
                    </div>
                </div>

                <div class="service-item">
                    <div class="service-icon">
                        {% if storage.status == 'healthy' %}
                            <i class="fas fa-cloud text-success"></i>
                        {% else %}
                            <i class="fas fa-cloud text-warning"></i>
                        {% endif %}
                    </div>
                    <div class="service-content">
                        <h4>Storage</h4>
                        <p>{{ storage.status|title }}</p>
                        <div class="service-details">
                            <span>Used: {{ storage.used_gb|floatformat:1 }} GB</span>
                            <span>Free: {{ storage.free_gb|floatformat:1 }} GB</span>
                            <span>Images: {{ storage.image_count }} files</span>
                        </div>
                    </div>
                    <div class="service-actions">
                        <button class="btn btn-sm btn-outline" onclick="cleanupStorage()">
                            <i class="fas fa-broom"></i>
                            Cleanup
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="analyzeStorage()">
                            <i class="fas fa-chart-pie"></i>
                            Analyze
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Logs -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-file-alt"></i>
                Recent System Logs
            </h3>
            <div class="card-actions">
                <select id="logLevel" class="form-control" style="width: 120px;">
                    <option value="">All Levels</option>
                    <option value="error">Error</option>
                    <option value="warning">Warning</option>
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                </select>
                <button class="btn btn-outline btn-sm" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="log-container">
                {% for log in system_logs %}
                <div class="log-entry log-{{ log.level }}">
                    <div class="log-timestamp">{{ log.timestamp|date:"H:i:s" }}</div>
                    <div class="log-level">{{ log.level|upper }}</div>
                    <div class="log-message">{{ log.message }}</div>
                    {% if log.details %}
                    <div class="log-details">{{ log.details }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-tachometer-alt"></i>
                Performance Metrics
            </h3>
            <div class="card-actions">
                <select id="timeRange" class="form-control" style="width: 120px;">
                    <option value="1h">Last Hour</option>
                    <option value="24h" selected>Last 24h</option>
                    <option value="7d">Last 7 Days</option>
                    <option value="30d">Last 30 Days</option>
                </select>
            </div>
        </div>
        <div class="card-content">
            <canvas id="performanceChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<style>
.stat-healthy {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.stat-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.stat-error {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.health-checks {
    space-y: 16px;
}

.health-check-item {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    padding: 16px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 12px;
}

.check-icon {
    font-size: 20px;
    flex-shrink: 0;
}

.check-content {
    flex: 1;
}

.check-content h4 {
    margin: 0 0 4px 0;
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
}

.check-content p {
    margin: 0 0 8px 0;
    color: #6b7280;
    font-size: 0.875rem;
}

.check-details {
    font-size: 0.875rem;
    color: #ef4444;
    background: #fee2e2;
    padding: 8px;
    border-radius: 4px;
}

.check-status {
    text-align: right;
    flex-shrink: 0;
}

.check-time {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
}

.service-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
}

.service-item {
    padding: 20px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.service-icon {
    font-size: 24px;
    margin-bottom: 12px;
}

.service-content h4 {
    margin: 0 0 8px 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #111827;
}

.service-content p {
    margin: 0 0 12px 0;
    color: #6b7280;
}

.service-details {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 16px;
}

.service-details span {
    font-size: 0.875rem;
    color: #6b7280;
}

.service-actions {
    display: flex;
    gap: 8px;
}

.log-container {
    max-height: 400px;
    overflow-y: auto;
    background: #1f2937;
    border-radius: 8px;
    padding: 16px;
    font-family: 'Courier New', monospace;
}

.log-entry {
    display: flex;
    gap: 12px;
    margin-bottom: 8px;
    font-size: 0.875rem;
    line-height: 1.4;
}

.log-timestamp {
    color: #9ca3af;
    width: 60px;
    flex-shrink: 0;
}

.log-level {
    width: 60px;
    flex-shrink: 0;
    font-weight: 600;
}

.log-error .log-level {
    color: #ef4444;
}

.log-warning .log-level {
    color: #f59e0b;
}

.log-info .log-level {
    color: #3b82f6;
}

.log-debug .log-level {
    color: #6b7280;
}

.log-message {
    flex: 1;
    color: #f3f4f6;
}

.log-details {
    flex: 1;
    color: #9ca3af;
    font-size: 0.8rem;
    margin-top: 4px;
}

.text-success {
    color: #10b981;
}

.text-warning {
    color: #f59e0b;
}

.text-danger {
    color: #ef4444;
}

.status-pass {
    background: #d1fae5;
    color: #065f46;
}

.status-warning {
    background: #fef3c7;
    color: #92400e;
}

.status-fail {
    background: #fee2e2;
    color: #dc2626;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Resource Usage Chart
    const resourceCtx = document.getElementById('resourceChart').getContext('2d');
    const resourceChart = new Chart(resourceCtx, {
        type: 'doughnut',
        data: {
            labels: ['CPU', 'Memory', 'Disk'],
            datasets: [{
                data: [
                    {{ system_health.cpu_usage }},
                    {{ system_health.memory_usage }},
                    {{ system_health.disk_usage }}
                ],
                backgroundColor: [
                    '#3b82f6',
                    '#10b981',
                    '#f59e0b'
                ],
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });

    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const performanceChart = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: {{ performance_metrics.timestamps|safe }},
            datasets: [{
                label: 'Response Time (ms)',
                data: {{ performance_metrics.response_times|safe }},
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 2,
                fill: true
            }, {
                label: 'Throughput (req/s)',
                data: {{ performance_metrics.throughput|safe }},
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                },
            }
        }
    });
});

function runHealthCheck() {
    fetch('{% url "dashboard:admin:health_check" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Health check failed: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error running health check');
    });
}

function stopAiService() {
    // Implement AI service stop
    alert('AI Service stopped');
}

function startAiService() {
    // Implement AI service start
    alert('AI Service started');
}

function restartAiService() {
    // Implement AI service restart
    alert('AI Service restarted');
}

function backupDatabase() {
    // Implement database backup
    alert('Database backup initiated');
}

function optimizeDatabase() {
    // Implement database optimization
    alert('Database optimization started');
}

function cleanupStorage() {
    // Implement storage cleanup
    alert('Storage cleanup initiated');
}

function analyzeStorage() {
    // Implement storage analysis
    alert('Storage analysis started');
}

function refreshLogs() {
    location.reload();
}

// Auto-refresh system health every 30 seconds
setInterval(function() {
    fetch('{% url "dashboard:admin:api_system_metrics" %}')
        .then(response => response.json())
        .then(data => {
            // Update metrics without full page reload
            updateSystemMetrics(data);
        })
        .catch(error => console.error('Error updating metrics:', error));
}, 30000);

function updateSystemMetrics(data) {
    // Update CPU, Memory, Disk usage
    document.querySelectorAll('.stat-content h3').forEach((element, index) => {
        if (index === 1) element.textContent = data.cpu_usage + '%';
        if (index === 2) element.textContent = data.memory_usage + '%';
        if (index === 3) element.textContent = data.disk_usage + '%';
    });
}
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block title %}Training Logs - Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-file-alt"></i>
            Training Logs
        </h1>
        <div class="admin-nav">
            <a href="{% url 'dashboard:admin:dashboard' %}" class="admin-nav-link">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </a>
            <a href="{% url 'dashboard:admin:model_management' %}" class="admin-nav-link">
                <i class="fas fa-brain"></i>
                Models
            </a>
            <a href="{% url 'dashboard:admin:train_model' %}" class="admin-nav-link">
                <i class="fas fa-play"></i>
                Train Model
            </a>
            <a href="{% url 'dashboard:admin:model_performance' %}" class="admin-nav-link">
                <i class="fas fa-chart-line"></i>
                Performance
            </a>
        </div>
    </div>

    <!-- Filter and Search -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-filter"></i>
                Filter Logs
            </h3>
        </div>
        <div class="card-content">
            <form method="get" class="filter-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">All Status</option>
                            <option value="running" {% if request.GET.status == 'running' %}selected{% endif %}>Running</option>
                            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="failed" {% if request.GET.status == 'failed' %}selected{% endif %}>Failed</option>
                            <option value="stopped" {% if request.GET.status == 'stopped' %}selected{% endif %}>Stopped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="date_from">From Date</label>
                        <input type="date" name="date_from" id="date_from" class="form-control" value="{{ request.GET.date_from }}">
                    </div>
                    <div class="form-group">
                        <label for="date_to">To Date</label>
                        <input type="date" name="date_to" id="date_to" class="form-control" value="{{ request.GET.date_to }}">
                    </div>
                    <div class="form-group">
                        <label for="search">Search</label>
                        <input type="text" name="search" id="search" class="form-control" placeholder="Search logs..." value="{{ request.GET.search }}">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i>
                        Filter
                    </button>
                    <a href="{% url 'dashboard:admin:training_logs' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Training Logs List -->
    <div class="admin-card">
        <div class="card-header">
            <h3>
                <i class="fas fa-list"></i>
                Training Sessions
            </h3>
            <div class="card-actions">
                <button class="btn btn-outline btn-sm" onclick="exportLogs()">
                    <i class="fas fa-download"></i>
                    Export
                </button>
                <button class="btn btn-outline btn-sm" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Session ID</th>
                            <th>Model Name</th>
                            <th>Status</th>
                            <th>Start Time</th>
                            <th>Duration</th>
                            <th>Progress</th>
                            <th>Accuracy</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in training_logs %}
                        <tr>
                            <td>
                                <code>{{ log.session_id|slice:":8" }}</code>
                            </td>
                            <td>
                                <strong>{{ log.model_name }}</strong>
                                <br>
                                <small class="text-muted">v{{ log.model_version }}</small>
                            </td>
                            <td>
                                {% if log.status == 'running' %}
                                    <span class="status status-running">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Running
                                    </span>
                                {% elif log.status == 'completed' %}
                                    <span class="status status-completed">
                                        <i class="fas fa-check"></i>
                                        Completed
                                    </span>
                                {% elif log.status == 'failed' %}
                                    <span class="status status-failed">
                                        <i class="fas fa-times"></i>
                                        Failed
                                    </span>
                                {% elif log.status == 'stopped' %}
                                    <span class="status status-stopped">
                                        <i class="fas fa-stop"></i>
                                        Stopped
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                {{ log.start_time|date:"M d, Y H:i" }}
                                <br>
                                <small class="text-muted">{{ log.start_time|timesince }} ago</small>
                            </td>
                            <td>
                                {% if log.end_time %}
                                    {{ log.duration|floatformat:1 }}h
                                {% elif log.status == 'running' %}
                                    <span class="text-info">
                                        <i class="fas fa-clock"></i>
                                        {{ log.elapsed_time|floatformat:1 }}h
                                    </span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.status == 'running' %}
                                    <div class="progress-bar-container">
                                        <div class="progress-bar" style="width: {{ log.progress }}%"></div>
                                        <span class="progress-text">{{ log.progress }}%</span>
                                    </div>
                                {% else %}
                                    <span class="text-muted">{{ log.progress }}%</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if log.final_accuracy %}
                                    <span class="metric-value">{{ log.final_accuracy|floatformat:2 }}%</span>
                                {% else %}
                                    <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group">
                                    <a href="{% url 'dashboard:admin:training_log_detail' log.id %}" class="btn btn-sm btn-outline">
                                        <i class="fas fa-eye"></i>
                                        View
                                    </a>
                                    {% if log.status == 'running' %}
                                    <form method="post" action="{% url 'dashboard:admin:stop_training' %}" class="inline-form">
                                        {% csrf_token %}
                                        <input type="hidden" name="session_id" value="{{ log.session_id }}">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to stop this training session?')">
                                            <i class="fas fa-stop"></i>
                                            Stop
                                        </button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="empty-state">
                                    <i class="fas fa-file-alt fa-3x"></i>
                                    <h3>No Training Logs</h3>
                                    <p>No training sessions have been recorded yet</p>
                                    <a href="{% url 'dashboard:admin:train_model' %}" class="btn btn-primary">
                                        <i class="fas fa-play"></i>
                                        Start Training
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    {% if training_logs.has_other_pages %}
    <div class="pagination-container">
        <div class="pagination">
            {% if training_logs.has_previous %}
            <a href="?page={{ training_logs.previous_page_number }}&{{ request.GET.urlencode }}" class="page-link">
                <i class="fas fa-chevron-left"></i>
                Previous
            </a>
            {% endif %}
            
            {% for num in training_logs.paginator.page_range %}
            {% if training_logs.number == num %}
            <span class="page-link active">{{ num }}</span>
            {% else %}
            <a href="?page={{ num }}&{{ request.GET.urlencode }}" class="page-link">{{ num }}</a>
            {% endif %}
            {% endfor %}
            
            {% if training_logs.has_next %}
            <a href="?page={{ training_logs.next_page_number }}&{{ request.GET.urlencode }}" class="page-link">
                Next
                <i class="fas fa-chevron-right"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<style>
.progress-bar-container {
    width: 100px;
    height: 20px;
    background-color: #e5e7eb;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #059669);
    border-radius: 10px;
    transition: width 0.3s ease;
}

.progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 500;
    color: #374151;
}

.status-running {
    background: #dbeafe;
    color: #1e40af;
}

.status-completed {
    background: #d1fae5;
    color: #065f46;
}

.status-failed {
    background: #fee2e2;
    color: #dc2626;
}

.status-stopped {
    background: #f3f4f6;
    color: #374151;
}

.filter-form {
    margin-bottom: 0;
}

.filter-form .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.btn-group {
    display: flex;
    gap: 8px;
}

.table-responsive {
    overflow-x: auto;
}

.text-info {
    color: #3b82f6;
}

.text-muted {
    color: #6b7280;
}

.metric-value {
    font-weight: 600;
    color: #10b981;
}
</style>

<script>
function refreshLogs() {
    window.location.reload();
}

function exportLogs() {
    // Create CSV data
    const csvData = [
        ['Session ID', 'Model Name', 'Status', 'Start Time', 'Duration', 'Progress', 'Accuracy']
    ];
    
    {% for log in training_logs %}
    csvData.push([
        '{{ log.session_id }}',
        '{{ log.model_name }}',
        '{{ log.status }}',
        '{{ log.start_time|date:"Y-m-d H:i:s" }}',
        '{% if log.duration %}{{ log.duration|floatformat:1 }}{% else %}{{ log.elapsed_time|floatformat:1 }}{% endif %}',
        '{{ log.progress }}',
        '{% if log.final_accuracy %}{{ log.final_accuracy|floatformat:2 }}{% else %}-{% endif %}'
    ]);
    {% endfor %}
    
    // Convert to CSV string
    const csvString = csvData.map(row => row.join(',')).join('\n');
    
    // Download CSV
    const blob = new Blob([csvString], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'training_logs_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Auto-refresh for running sessions
{% if has_running_sessions %}
setInterval(function() {
    const runningRows = document.querySelectorAll('.status-running');
    if (runningRows.length > 0) {
        fetch('{% url "dashboard:admin:api_training_status" %}')
            .then(response => response.json())
            .then(data => {
                // Update progress bars and status
                data.running_sessions.forEach(session => {
                    const row = document.querySelector(`[data-session-id="${session.id}"]`);
                    if (row) {
                        const progressBar = row.querySelector('.progress-bar');
                        const progressText = row.querySelector('.progress-text');
                        if (progressBar && progressText) {
                            progressBar.style.width = session.progress + '%';
                            progressText.textContent = session.progress + '%';
                        }
                    }
                });
            })
            .catch(error => console.error('Error updating training status:', error));
    }
}, 5000); // Update every 5 seconds
{% endif %}
</script>
{% endblock %}
{% extends 'dashboard/admin_base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/admin.css' %}">
{% endblock %}

{% block content %}
<div class="admin-train-model">
    <!-- Header -->
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="fas fa-cogs"></i>
            Train New Model
        </h1>
        <div class="admin-nav">
            <a href="{% url 'admin_model_management' %}" class="admin-nav-link">
                <i class="fas fa-arrow-left"></i>
                Back to Models
            </a>
        </div>
    </div>

    <!-- Training Form -->
    <div class="train-form-container">
        <div class="train-form-card">
            <div class="form-header">
                <h3>Training Configuration</h3>
                <p>Configure the parameters for training a new AI model</p>
            </div>

            <form method="post" class="train-form">
                {% csrf_token %}
                
                <!-- Dataset Selection -->
                <div class="form-group">
                    <label for="dataset_path">Dataset</label>
                    <select name="dataset_path" id="dataset_path" class="form-control" required>
                        <option value="">Select a dataset</option>
                        <option value="training_data">Default Training Data</option>
                        {% for dataset in datasets %}
                        <option value="{{ dataset.path }}">
                            {{ dataset.name }} ({{ dataset.image_count }} images)
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-help">
                        Choose the dataset to train the model on. Each dataset should contain organized folders by disease type.
                    </div>
                </div>

                <!-- Model Version -->
                <div class="form-group">
                    <label for="model_version">Model Version</label>
                    <input type="text" name="model_version" id="model_version" 
                           class="form-control" placeholder="e.g., tomato_v2.0">
                    <div class="form-help">
                        Optional: Specify a version name for the model. If left empty, a timestamp will be used.
                    </div>
                </div>

                <!-- Training Parameters -->
                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="epochs">Epochs</label>
                        <input type="number" name="epochs" id="epochs" 
                               class="form-control" value="20" min="1" max="200" required>
                        <div class="form-help">
                            Number of training epochs (1-200). More epochs can improve accuracy but take longer.
                        </div>
                    </div>

                    <div class="form-group half-width">
                        <label for="batch_size">Batch Size</label>
                        <input type="number" name="batch_size" id="batch_size" 
                               class="form-control" value="16" min="1" max="128" required>
                        <div class="form-help">
                            Batch size for training (1-128). Smaller batches use less memory but may be slower.
                        </div>
                    </div>
                </div>

                <!-- Advanced Options -->
                <div class="form-group">
                    <label class="form-checkbox">
                        <input type="checkbox" id="advanced_options">
                        <span class="checkmark"></span>
                        Show Advanced Options
                    </label>
                </div>

                <div id="advanced_section" class="advanced-options" style="display: none;">
                    <div class="form-row">
                        <div class="form-group half-width">
                            <label for="learning_rate">Learning Rate</label>
                            <input type="number" name="learning_rate" id="learning_rate" 
                                   class="form-control" value="0.001" min="0.0001" max="0.1" step="0.0001">
                            <div class="form-help">
                                Learning rate for the optimizer (0.0001-0.1).
                            </div>
                        </div>

                        <div class="form-group half-width">
                            <label for="validation_split">Validation Split</label>
                            <input type="number" name="validation_split" id="validation_split" 
                                   class="form-control" value="0.2" min="0.1" max="0.5" step="0.1">
                            <div class="form-help">
                                Percentage of data to use for validation (0.1-0.5).
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-large">
                        <i class="fas fa-play"></i>
                        Start Training
                    </button>
                    <a href="{% url 'admin_model_management' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancel
                    </a>
                </div>
            </form>
        </div>

        <!-- Dataset Information -->
        <div class="dataset-info-card">
            <div class="card-header">
                <h3>Dataset Information</h3>
            </div>
            <div class="card-content">
                <div class="dataset-list">
                    {% for dataset in datasets %}
                    <div class="dataset-item">
                        <div class="dataset-name">{{ dataset.name }}</div>
                        <div class="dataset-stats">
                            <span class="stat">
                                <i class="fas fa-images"></i>
                                {{ dataset.image_count }} images
                            </span>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-database"></i>
                        <p>No datasets found. Please add training data to get started.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Training Tips -->
    <div class="training-tips">
        <h3>
            <i class="fas fa-lightbulb"></i>
            Training Tips
        </h3>
        <div class="tips-grid">
            <div class="tip-item">
                <div class="tip-icon">
                    <i class="fas fa-database"></i>
                </div>
                <div class="tip-content">
                    <h4>Dataset Quality</h4>
                    <p>Ensure your dataset has balanced classes and high-quality images for better model performance.</p>
                </div>
            </div>

            <div class="tip-item">
                <div class="tip-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="tip-content">
                    <h4>Training Time</h4>
                    <p>Training can take 30-60 minutes depending on dataset size and epochs. Monitor progress in the Models section.</p>
                </div>
            </div>

            <div class="tip-item">
                <div class="tip-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="tip-content">
                    <h4>Model Performance</h4>
                    <p>Aim for validation accuracy above 70% and minimize the gap between training and validation accuracy.</p>
                </div>
            </div>

            <div class="tip-item">
                <div class="tip-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="tip-content">
                    <h4>Hyperparameters</h4>
                    <p>Start with default settings. Adjust learning rate and epochs based on initial results.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Advanced options toggle
document.getElementById('advanced_options').addEventListener('change', function() {
    const advancedSection = document.getElementById('advanced_section');
    if (this.checked) {
        advancedSection.style.display = 'block';
    } else {
        advancedSection.style.display = 'none';
    }
});

// Dataset selection handler
document.getElementById('dataset_path').addEventListener('change', function() {
    const selectedPath = this.value;
    // You can add logic here to show dataset details
    console.log('Selected dataset:', selectedPath);
});

// Form validation
document.querySelector('.train-form').addEventListener('submit', function(e) {
    const dataset = document.getElementById('dataset_path').value;
    const epochs = parseInt(document.getElementById('epochs').value);
    const batchSize = parseInt(document.getElementById('batch_size').value);
    
    if (!dataset) {
        alert('Please select a dataset');
        e.preventDefault();
        return;
    }
    
    if (epochs < 1 || epochs > 200) {
        alert('Epochs must be between 1 and 200');
        e.preventDefault();
        return;
    }
    
    if (batchSize < 1 || batchSize > 128) {
        alert('Batch size must be between 1 and 128');
        e.preventDefault();
        return;
    }
    
    // Show confirmation
    const confirmed = confirm(
        `Are you sure you want to start training?\n\n` +
        `Dataset: ${dataset}\n` +
        `Epochs: ${epochs}\n` +
        `Batch Size: ${batchSize}\n\n` +
        `Training may take 30-60 minutes to complete.`
    );
    
    if (!confirmed) {
        e.preventDefault();
    }
});

// Auto-generate model version based on current date
document.getElementById('model_version').addEventListener('focus', function() {
    if (!this.value) {
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/[:\-T]/g, '');
        this.value = `model_${timestamp}`;
    }
});
</script>
{% endblock %}
